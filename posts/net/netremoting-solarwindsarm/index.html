<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>【.Net Remoting 系列二】 Solarwinds ARM 漏洞分析 - g7shot's blog</title><meta name=Description content><meta property="og:url" content="https://g7shot.com/posts/net/netremoting-solarwindsarm/">
<meta property="og:site_name" content="g7shot's blog"><meta property="og:title" content="【.Net Remoting 系列二】 Solarwinds ARM 漏洞分析"><meta property="og:description" content="首发于https://forum.butian.net/share/3998 本篇主要是以Solarwinds Arm产品介绍自定义ServerChanel的场景，漏洞分析利用是其次，事实上是去年挖的没有详细记录，后续写的，勿怪哈哈哈"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-26T17:57:22+08:00"><meta property="article:modified_time" content="2024-12-26T17:57:22+08:00"><meta property="article:tag" content=".NET"><meta property="article:tag" content="漏洞挖掘"><meta property="article:tag" content="反序列化"><meta name=twitter:card content="summary"><meta name=twitter:title content="【.Net Remoting 系列二】 Solarwinds ARM 漏洞分析"><meta name=twitter:description content="首发于https://forum.butian.net/share/3998 本篇主要是以Solarwinds Arm产品介绍自定义ServerChanel的场景，漏洞分析利用是其次，事实上是去年挖的没有详细记录，后续写的，勿怪哈哈哈"><meta name=application-name content="g7shot's blog"><meta name=apple-mobile-web-app-title content="g7shot's blog"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://g7shot.com/posts/net/netremoting-solarwindsarm/><link rel=prev href=https://g7shot.com/posts/net/netremoting101/><link rel=next href=https://g7shot.com/posts/net/netremoting-veeambackuprce/><link rel=stylesheet href=/css/main.min.css><link rel=stylesheet href=/css/style.min.css><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"【.Net Remoting 系列二】 Solarwinds ARM 漏洞分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://g7shot.com/posts/net/netremoting-solarwindsarm/"},"genre":"posts","keywords":[".NET","漏洞挖掘","反序列化"],"wordcount":3186,"url":"https://g7shot.com/posts/net/netremoting-solarwindsarm/","datePublished":"2024-12-26T17:57:22+08:00","dateModified":"2024-12-26T17:57:22+08:00","publisher":{"@type":"Organization","name":"g7shot"},"author":{"@type":"Person","name":"g7shot","url":"/"},"description":""}</script></head><body data-instant-intensity=viewport><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.className=e,document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),e==="light"?document.documentElement.classList.remove("tw-dark"):document.documentElement.classList.add("tw-dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#161b22"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class="desktop print:!tw-hidden" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="g7shot's blog">g7shot's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/note/>笔记 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<button class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear" id=search-clear-desktop title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-desktop><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
</span></span><button class="menu-item theme-switch" aria-label=切换主题><svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg></button></div></div></div></header><header class="mobile print:!tw-hidden" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="g7shot's blog">g7shot's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<button class="search-button search-toggle tw-h-10" id=search-toggle-mobile title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear" id=search-clear-mobile title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-mobile><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg></span></div><button class=search-cancel id=search-cancel-mobile>
取消</button></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/note/ title>笔记</a><button class="menu-item theme-switch tw-w-full" aria-label=切换主题><svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg></button></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="toc print:!tw-hidden" id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#起因>起因</a></li><li><a href=#自定义的serverchannel>自定义的ServerChannel</a></li><li><a href=#remoting功能代码逻辑分析>Remoting功能代码逻辑分析</a></li><li><a href=#漏洞分析>漏洞分析</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single print:!tw-w-full print:!tw-max-w-none print:!tw-m-0 print:!tw-p-0"><h1 class=single-title data-pagefind-meta=date:2024-12-26 data-pagefind-body>【.Net Remoting 系列二】 Solarwinds ARM 漏洞分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><svg class="icon" viewBox="0 0 496 512"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6.0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7.0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4.0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9s28-2.7 40.9-6.9c2.3-.7 4.7-1.1 7.1-1.1 42.9.0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><a href=/ title=Author rel=author class=author>g7shot</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/><svg class="icon" viewBox="0 0 512 512"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>代码审计</a></span></div><div class=post-meta-line><svg class="icon" viewBox="0 0 448 512"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;<time datetime=2024-12-26>2024-12-26</time>&nbsp;<svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>&nbsp;<time datetime=2024-12-26>2024-12-26</time>&nbsp;<svg class="icon" viewBox="0 0 512 512"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;约 3186 字&nbsp;
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;预计阅读 14 分钟&nbsp;</div></div><div class="details toc print:!tw-block" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#起因>起因</a></li><li><a href=#自定义的serverchannel>自定义的ServerChannel</a></li><li><a href=#remoting功能代码逻辑分析>Remoting功能代码逻辑分析</a></li><li><a href=#漏洞分析>漏洞分析</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content data-pagefind-body><div class="details admonition note open"><div class="details-summary admonition-title"><span class=icon><svg class="icon" viewBox="0 0 512 512"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg></span>注意<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2024-12-26T17:57:22 title="December 26, 2024">2024-12-26</span>，文中内容可能已过时。</div></div></div><p>首发于https://forum.butian.net/share/3998
本篇主要是以Solarwinds Arm产品介绍自定义ServerChanel的场景，漏洞分析利用是其次，事实上是去年挖的没有详细记录，后续写的，勿怪哈哈哈</p><h2 id=起因 class=headerLink><a href=#%e8%b5%b7%e5%9b%a0 class=header-mark></a>起因</h2><p>最开始的漏洞是由@SinSinology挖掘的<a href="https://www.cve.org/CVERecord?id=CVE-2023-35187" target=_blank rel="noopener noreferrer">CVE-2023-35187</a>后续又出现了很多CVE。</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">text</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-1 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>This vulnerability allows remote attackers to execute arbitrary code on affected installations of SolarWinds Access Rights Manager. Authentication is not required to exploit this vulnerability.The specific flaw exists within the OpenClientUpdateFile method. The issue results from the lack of proper validation of a user-supplied path prior to using it in file operations. An attacker can leverage this vulnerability to execute code in the context of SYSTEM.</span></span></code></pre></div><h2 id=自定义的serverchannel class=headerLink><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e7%9a%84serverchannel class=header-mark></a>自定义的ServerChannel</h2><p>根据漏洞描述可以定位到OpenClientUpdateFile方法；</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-2 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>TattleImplementation</span> <span class=p>:</span> <span class=n>RemotingObject</span><span class=p>,</span> <span class=n>ITattle</span><span class=p>,</span> <span class=n>IPing</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>......</span>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=n>Guid</span> <span class=n>OpenClientUpdateFile</span><span class=p>(</span><span class=kt>string</span> <span class=n>fileName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Guid</span> <span class=n>guid2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>MethodCall</span> <span class=n>methodCall</span> <span class=p>=</span> <span class=k>new</span> <span class=n>MethodCall</span><span class=p>(</span><span class=k>this</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Guid</span> <span class=n>guid</span> <span class=p>=</span> <span class=n>Guid</span><span class=p>.</span><span class=n>NewGuid</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>using</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>fileStreams</span><span class=p>.</span><span class=n>Lock</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=n>fileStreams</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>guid</span><span class=p>,</span> <span class=k>new</span> <span class=n>FileStream</span><span class=p>(</span><span class=n>Path</span><span class=p>.</span><span class=n>Combine</span><span class=p>(</span><span class=n>ApplicationPaths</span><span class=p>.</span><span class=n>Instance</span><span class=p>.</span><span class=n>InstallationPath</span><span class=p>,</span> <span class=n>fileName</span><span class=p>),</span> <span class=n>FileMode</span><span class=p>.</span><span class=n>Open</span><span class=p>,</span> <span class=n>FileAccess</span><span class=p>.</span><span class=n>Read</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>guid2</span> <span class=p>=</span> <span class=n>methodCall</span><span class=p>.</span><span class=n>SetResult</span><span class=p>&lt;</span><span class=n>Guid</span><span class=p>&gt;(</span><span class=n>guid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>guid2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>byte</span><span class=p>[]</span> <span class=n>ReadClientUpdateFile</span><span class=p>(</span><span class=n>Guid</span> <span class=n>updateId</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>byte</span><span class=p>[]</span> <span class=n>array</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=p>[</span><span class=n>maxBytes</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>fileStreams</span><span class=p>.</span><span class=n>Lock</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>num</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>fileStreams</span><span class=p>[</span><span class=n>updateId</span><span class=p>].</span><span class=n>Read</span><span class=p>(</span><span class=n>array</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>maxBytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>Array</span><span class=p>.</span><span class=n>Resize</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;(</span><span class=k>ref</span> <span class=n>array</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>array</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>......</span></span></span></code></pre></div><p>很明显可以通过调用OpenClientUpdateFile返回的guid再调用ReadClientUpdateFile可以读取任意文件，并且该类继承<code>RemotingObject</code>，该类实现如下</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-3 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Runtime.Remoting</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>pn.remoting</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=k>class</span> <span class=nc>RemotingObject</span> <span class=p>:</span> <span class=n>MarshalByRefObject</span><span class=p>,</span> <span class=n>IDisposable</span><span class=p>,</span> <span class=n>IPing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>override</span> <span class=kt>object</span> <span class=n>InitializeLifetimeService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>Ping</span><span class=p>(</span><span class=kt>string</span> <span class=n>packet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>packet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=k>void</span> <span class=n>InstantiateInterface</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=k>virtual</span> <span class=k>void</span> <span class=n>Dispose</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>RemotingServices</span><span class=p>.</span><span class=n>Disconnect</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>可以看到该类继承自MarshalByRefObject，判断是漏洞是.Net Remoting导致的，全局搜索发现主要处理在SolarWinds.ARM.Remoting.dll。看到GrpcServerChannel类</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-4 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>SolarWinds.ARM.Remoting</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>internal</span> <span class=kd>sealed</span> <span class=k>class</span> <span class=nc>GrpcServerChannel</span> <span class=p>:</span> <span class=n>IChannelReceiver</span><span class=p>,</span> <span class=n>IChannel</span><span class=p>,</span> <span class=n>ISecurableChannel</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=n>GrpcServerChannel</span><span class=p>(</span><span class=n>IGrpcRemotingChannelManager</span> <span class=n>grpcChannelManager</span><span class=p>,</span> <span class=kt>string</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>port</span><span class=p>,</span> <span class=n>IServerChannelSinkProvider</span> <span class=n>sinkProvider</span> <span class=p>=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>port</span> <span class=p>=</span> <span class=n>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>machineName</span> <span class=p>=</span> <span class=n>Dns</span><span class=p>.</span><span class=n>GetHostName</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>baseAddresses</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>string</span><span class=p>[</span><span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>grpcChannelManager</span> <span class=p>=</span> <span class=n>grpcChannelManager</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>name</span> <span class=p>=</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>sinkProvider</span> <span class=p>=</span> <span class=n>sinkProvider</span> <span class=p>??</span> <span class=k>new</span> <span class=n>BinaryServerFormatterSinkProvider</span><span class=p>(</span><span class=k>new</span> <span class=n>Hashtable</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span> <span class=s>&#34;includeVersions&#34;</span><span class=p>,</span> <span class=kc>false</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;typeFilterLevel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=n>TypeFilterLevel</span><span class=p>.</span><span class=n>Full</span><span class=p>.</span><span class=n>ToString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>setupChannel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>StartListening</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>......</span></span></span></code></pre></div><p>和TcpServerChannel类似的实现，看样子是服务端是基于GRPC的ServerChannel，下面分析它处理的大致逻辑。</p><h2 id=remoting功能代码逻辑分析 class=headerLink><a href=#remoting%e5%8a%9f%e8%83%bd%e4%bb%a3%e7%a0%81%e9%80%bb%e8%be%91%e5%88%86%e6%9e%90 class=header-mark></a>Remoting功能代码逻辑分析</h2><p>按照之前的思路梳理自定义的ServerChannel，看看注册的Channel类型是否是GrpcServerChannel，查找ChannelServices#RegisterChannelInternal的调用，找到GrpcRemotingChannelCreator#createGlobalServerChannelInternal方法，实现如下</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-5 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>createGlobalServerChannelInternal</span><span class=p>(</span><span class=kt>int</span> <span class=n>port</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>selectServerPort</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=n>text</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;port_{0}&#34;</span><span class=p>,</span> <span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>object</span> <span class=n>obj</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>channelAccess</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>lock</span> <span class=p>(</span><span class=n>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>IDictionary</span> <span class=n>dictionary</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Hashtable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>dictionary</span><span class=p>[</span><span class=s>&#34;includeVersions&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dictionary</span><span class=p>[</span><span class=s>&#34;typeFilterLevel&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=n>TypeFilterLevel</span><span class=p>.</span><span class=n>Full</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>IServerChannelSinkProvider</span> <span class=n>serverChannelSinkProvider2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=k>this</span><span class=p>.</span><span class=n>applicationConfiguration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>&lt;</span><span class=kt>bool</span><span class=p>&gt;(</span><span class=s>&#34;network.dump.enabled&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>IServerChannelSinkProvider</span> <span class=n>serverChannelSinkProvider</span> <span class=p>=</span> <span class=k>new</span> <span class=n>BinaryServerFormatterSinkProvider</span><span class=p>(</span><span class=n>dictionary</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverChannelSinkProvider2</span> <span class=p>=</span> <span class=n>serverChannelSinkProvider</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>......</span>
</span></span><span class=line><span class=cl>        <span class=n>IServerChannelSinkProvider</span> <span class=n>serverChannelSinkProvider3</span> <span class=p>=</span> <span class=n>serverChannelSinkProvider2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>IChannelReceiver</span> <span class=n>channelReceiver</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>selectServerPort</span> <span class=p>||</span> <span class=n>port</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channelReceiver</span> <span class=p>=</span> <span class=k>new</span> <span class=n>GrpcServerChannel</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>grpcManager</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>serverChannelSinkProvider3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=n>hostname</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Uri</span><span class=p>(</span><span class=n>channelReceiver</span><span class=p>.</span><span class=n>GetUrlsForUri</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)[</span><span class=m>0</span><span class=p>]).</span><span class=n>Host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>grpcManager</span><span class=p>.</span><span class=n>LocalPort</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=n>SetProperties</span><span class=p>(</span><span class=k>new</span> <span class=n>Dictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object</span><span class=p>&gt;(</span><span class=n>StringComparer</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span> <span class=s>&#34;LocalPort&#34;</span><span class=p>,</span> <span class=n>port</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span> <span class=s>&#34;remoteHost&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>DnsHostName</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span> <span class=s>&#34;remotePort&#34;</span><span class=p>,</span> <span class=n>port</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=n>StringBuilder</span> <span class=n>sb</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>(</span><span class=s>&#34; gRPC .netRemoting listen on port &#34;</span><span class=p>).</span><span class=n>AppendLine</span><span class=p>(</span><span class=n>port</span><span class=p>.</span><span class=n>ToString</span><span class=p>()).</span><span class=n>AppendLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;ARM is using following channel URIs[{0}]: &#34;</span><span class=p>,</span> <span class=p>((</span><span class=n>GrpcServerChannel</span><span class=p>)</span><span class=n>channelReceiver</span><span class=p>).</span><span class=n>ChannelUris</span><span class=p>.</span><span class=n>Length</span><span class=p>));</span>
</span></span><span class=line><span class=cl>           <span class=p>((</span><span class=n>GrpcServerChannel</span><span class=p>)</span><span class=n>channelReceiver</span><span class=p>).</span><span class=n>ChannelUris</span><span class=p>.</span><span class=n>ForEach</span><span class=p>(</span><span class=k>delegate</span><span class=p>(</span><span class=kt>string</span> <span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>sb</span><span class=p>.</span><span class=n>AppendLine</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>sb</span><span class=p>.</span><span class=n>ToString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ChannelServices</span><span class=p>.</span><span class=n>RegisterChannel</span><span class=p>(</span><span class=n>channelReceiver</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=n>grpcManager</span><span class=p>.</span><span class=n>LocalPort</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>传入GrpcServerChannel的sinkProvider为BinaryServerFormatterSinkProvider，并开启了Full Type Filter。</p><p>下面梳理sinkProviderChains：通读<code>SolarWinds.ARM.Remoting.GrpcServerChannel</code>的代码，和TcpServerChannel大同小异，实现大致如下</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-6 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>//构造函数TypeFilterLevel为Full</span>
</span></span><span class=line><span class=cl><span class=c1>//调用setupChannel</span>
</span></span><span class=line><span class=cl><span class=c1>//调用StartListening</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=k>void</span> <span class=n>setupChannel</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>channelData</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ChannelDataStore</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建默认的SinkProviderChain provider，这里之前创建的就是BinaryServerFormatterSinkProvider</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>sinkProvider</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=p>.</span><span class=n>sinkProvider</span> <span class=p>=</span> <span class=n>ChannelHelper</span><span class=p>.</span><span class=n>CreateDefaultServerProviderChain</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>port</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>grpcChannelManager</span><span class=p>.</span><span class=n>BindPort</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>Log</span><span class=p>.</span><span class=n>debug</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;gRPC channel bound to port {0}&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>port</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>baseAddresses</span> <span class=p>=</span> <span class=p>(</span><span class=k>from</span> <span class=n>hostname</span> <span class=k>in</span> <span class=k>this</span><span class=p>.</span><span class=n>grpcChannelManager</span><span class=p>.</span><span class=n>HostNames</span>
</span></span><span class=line><span class=cl>	<span class=k>select</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;{0}{1}:{2}&#34;</span><span class=p>,</span> <span class=s>&#34;grpc://&#34;</span><span class=p>,</span> <span class=n>hostname</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>port</span><span class=p>)).</span><span class=n>ToArray</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>	<span class=n>Log</span><span class=p>.</span><span class=n>debug</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;gRPC determines channel addresses by network interfaces [{0}] {1} {2}&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>baseAddresses</span><span class=p>.</span><span class=n>Length</span><span class=p>,</span> <span class=n>Environment</span><span class=p>.</span><span class=n>NewLine</span><span class=p>,</span> <span class=kt>string</span><span class=p>.</span><span class=n>Join</span><span class=p>(</span><span class=n>Environment</span><span class=p>.</span><span class=n>NewLine</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>baseAddresses</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>port</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=p>.</span><span class=n>channelData</span><span class=p>.</span><span class=n>ChannelUris</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>baseAddresses</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//这里和TcpServerChannel一样</span>
</span></span><span class=line><span class=cl>	<span class=n>CoreChannel</span><span class=p>.</span><span class=n>CollectChannelDataFromServerSinkProviders</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>channelData</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>sinkProvider</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>transportSink</span> <span class=p>=</span> <span class=k>new</span> <span class=n>GrpcServerChannel</span><span class=p>.</span><span class=n>GrpcServerTransportSink</span><span class=p>(</span><span class=n>ChannelServices</span><span class=p>.</span><span class=n>CreateServerChannelSinkChain</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>sinkProvider</span><span class=p>,</span> <span class=k>this</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>num</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>.......</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>StartListening</span><span class=p>(</span><span class=kt>object</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//GrpcServerTransportSink绑定到port_55555</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>grpcChannelManager</span><span class=p>.</span><span class=n>BindChannel</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;port_{0}&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>grpcChannelManager</span><span class=p>.</span><span class=n>LocalPort</span><span class=p>),</span> <span class=k>this</span><span class=p>.</span><span class=n>transportSink</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>这里的sinkProvider和TcpServerChannel一样，但是transportsink是自己实现的，跟进下</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-7 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=kd>internal</span> <span class=kd>sealed</span> <span class=k>class</span> <span class=nc>GrpcServerTransportSink</span> <span class=p>:</span> <span class=n>IServerChannelSink</span><span class=p>,</span> <span class=n>IChannelSinkBase</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>internal</span> <span class=n>GrpcServerTransportSink</span><span class=p>(</span><span class=n>IServerChannelSink</span> <span class=n>nextSink</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>this</span><span class=p>.</span><span class=n>nextSink</span> <span class=p>=</span> <span class=n>nextSink</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=kd>public</span> <span class=n>ServerProcessing</span> <span class=n>ProcessMessage</span><span class=p>(</span><span class=n>IServerChannelSinkStack</span> <span class=n>sinkStack</span><span class=p>,</span> <span class=n>IMessage</span> <span class=n>requestMsg</span><span class=p>,</span> <span class=n>ITransportHeaders</span> <span class=n>requestHeaders</span><span class=p>,</span> <span class=n>Stream</span> <span class=n>requestStream</span><span class=p>,</span> <span class=k>out</span> <span class=n>IMessage</span> <span class=n>responseMsg</span><span class=p>,</span> <span class=k>out</span> <span class=n>ITransportHeaders</span> <span class=n>responseHeaders</span><span class=p>,</span> <span class=k>out</span> <span class=n>Stream</span> <span class=n>responseStream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=k>new</span> <span class=n>NotSupportedException</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span></span></span></code></pre></div><p>这里实现非常简单，初步看起来整个Channel Sinks Chains像是<code>GrpcServerTransportSink-->BinaryServerFormatterSink-->Dispatch</code>。</p><p>继续看完GrpcServerChannel</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-8 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>// GrpcServerChannel</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>StartListening</span><span class=p>(</span><span class=kt>object</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>grpcChannelManager</span><span class=p>.</span><span class=n>BindChannel</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;port_{0}&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>grpcChannelManager</span><span class=p>.</span><span class=n>LocalPort</span><span class=p>),</span> <span class=k>this</span><span class=p>.</span><span class=n>transportSink</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// GrpcRemotingChannelManager</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>BindChannel</span><span class=p>(</span><span class=kt>string</span> <span class=n>channelName</span><span class=p>,</span> <span class=n>IServerChannelSink</span> <span class=n>serverChannelSink</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>serverChannels</span><span class=p>[</span><span class=n>channelName</span><span class=p>]</span> <span class=p>=</span> <span class=n>serverChannelSink</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>startGrpc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=k>void</span> <span class=n>startGrpc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>lock</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>isRunning</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=p>.</span><span class=n>isRunning</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>grpcManager</span><span class=p>.</span><span class=n>Register</span><span class=p>(</span><span class=k>new</span> <span class=n>ServerServiceDefinition</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Remoting</span><span class=p>.</span><span class=n>BindService</span><span class=p>(</span><span class=k>new</span> <span class=n>GrpcRemotingService</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>serviceCollection</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>serverChannels</span><span class=p>,</span> <span class=k>this</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=n>grpcManager</span><span class=p>.</span><span class=n>StartServer</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>在开启监听的同时通过Grpc的方式注册了GrpcRemotingService的服务，查看其实现</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-9 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>SolarWinds.ARM.Remoting</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>internal</span> <span class=kd>sealed</span> <span class=k>class</span> <span class=nc>GrpcRemotingService</span> <span class=p>:</span> <span class=n>Remoting</span><span class=p>.</span><span class=n>RemotingBase</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>serviceCollection</span> <span class=p>=</span> <span class=n>serviceCollection</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>serverChannelSinks</span> <span class=p>=</span> <span class=n>serverChannelSinks</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=p>.</span><span class=n>subscriberProvider</span> <span class=p>=</span> <span class=n>subscriberProvider</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=kd>override</span> <span class=kd>async</span> <span class=n>Task</span> <span class=n>Send</span><span class=p>(</span><span class=n>IAsyncStreamReader</span><span class=p>&lt;</span><span class=n>RemotingMessageRequest</span><span class=p>&gt;</span> <span class=n>requestStream</span><span class=p>,</span> <span class=n>IServerStreamWriter</span><span class=p>&lt;</span><span class=n>RemotingMessageReply</span><span class=p>&gt;</span> <span class=n>responseStream</span><span class=p>,</span> <span class=n>ServerCallContext</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>......</span>
</span></span><span class=line><span class=cl>				<span class=n>GrpcRemotingService</span><span class=p>.</span><span class=n>HandelRequest</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>requestMemStream</span><span class=p>,</span> <span class=n>responseStream</span><span class=p>,</span> <span class=n>serverChannelSink</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>catch</span> <span class=p>(</span><span class=n>OperationCanceledException</span> <span class=n>ex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=k>new</span> <span class=n>RemotingException</span><span class=p>(</span><span class=s>&#34;Timeout&#34;</span><span class=p>,</span> <span class=n>ex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>finally</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Stream</span> <span class=n>stream</span> <span class=p>=</span> <span class=n>requestMemStream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>stream</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>stream</span><span class=p>.</span><span class=n>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>TempFileCollection</span> <span class=n>tempFileCollection2</span> <span class=p>=</span> <span class=n>tempFileCollection</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>tempFileCollection2</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=p>((</span><span class=n>IDisposable</span><span class=p>)</span><span class=n>tempFileCollection2</span><span class=p>).</span><span class=n>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>internal</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>HandelRequest</span><span class=p>(</span><span class=n>RemotingMessageRequest</span> <span class=n>request</span><span class=p>,</span> <span class=n>Stream</span> <span class=n>requestStream</span><span class=p>,</span> <span class=n>IServerStreamWriter</span><span class=p>&lt;</span><span class=n>RemotingMessageReply</span><span class=p>&gt;</span> <span class=n>responseMessageStream</span><span class=p>,</span> <span class=n>IServerChannelSink</span> <span class=n>serverChannelSink</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>ITransportHeaders</span> <span class=n>transportHeaders</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>Headers</span><span class=p>.</span><span class=n>ToTransportHeaders</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=n>transportHeaders</span><span class=p>[</span><span class=s>&#34;__CustomErrorsEnabled&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=kt>string</span> <span class=n>uri</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>Uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=kt>string</span> <span class=n>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>ChannelHelper</span><span class=p>.</span><span class=n>ParseGrpcURL</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=k>out</span> <span class=n>text</span><span class=p>)</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>text</span> <span class=p>=</span> <span class=n>uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>transportHeaders</span><span class=p>[</span><span class=s>&#34;__RequestUri&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=n>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>ServerChannelSinkStack</span> <span class=n>serverChannelSinkStack</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ServerChannelSinkStack</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=n>serverChannelSinkStack</span><span class=p>.</span><span class=n>Push</span><span class=p>(</span><span class=n>serverChannelSink</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>ServerProcessing</span> <span class=n>serverProcessing</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>try</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>global</span><span class=p>::</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>Remoting</span><span class=p>.</span><span class=n>Messaging</span><span class=p>.</span><span class=n>IMessage</span> <span class=n>message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>ITransportHeaders</span> <span class=n>transportHeaders2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>Stream</span> <span class=n>stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=c1>// GrpcServer初始化时已设置默认的链为BinaryServerFormatterSink</span>
</span></span><span class=line><span class=cl>				<span class=n>serverProcessing</span> <span class=p>=</span> <span class=n>serverChannelSink</span><span class=p>.</span><span class=n>NextChannelSink</span><span class=p>.</span><span class=n>ProcessMessage</span><span class=p>(</span><span class=n>serverChannelSinkStack</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>transportHeaders</span><span class=p>,</span> <span class=n>requestStream</span><span class=p>,</span> <span class=k>out</span> <span class=n>message</span><span class=p>,</span> <span class=k>out</span> <span class=n>transportHeaders2</span><span class=p>,</span> <span class=k>out</span> <span class=n>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=kt>byte</span><span class=p>[]</span> <span class=n>array</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=p>[</span><span class=m>1048576</span><span class=p>];</span>
</span></span><span class=line><span class=cl>				<span class=kt>int</span> <span class=n>num</span> <span class=p>=</span> <span class=n>stream</span><span class=p>.</span><span class=n>Read</span><span class=p>(</span><span class=n>array</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>array</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>......</span></span></span></code></pre></div><p>如果熟悉C#中的<a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/basics?view=aspnetcore-8.0" target=_blank rel="noopener noreferrer">Grpc</a>就知道，该服务中的send方法可由客户端调用，进而调用HandelRequest方法，其实现就很熟悉了类似TcpServerTransportSink的ServiceRequest方法，根据代码逻辑，最后传递到BinaryServerFormatterSink#ProcessMessage方法处理。</p><p>整个sinkProviderChains需要参杂Grpc的调用，整个链就为<code>GrpcRemotingService(GrpcRemotingService#send-->GrpcRemotingService#HandelRequest)-->BinaryServerFormatterSink-->Dispatch</code>。</p><p>刚好服务端的代码也存在GrpcClientChannel，为了进一步验证，看下整个数据流</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">csharp</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-10 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>//GrpcClientChannel</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>IClientChannelSinkProvider</span> <span class=n>createDefaultClientProviderChain</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>IClientChannelSinkProvider</span> <span class=n>clientChannelSinkProvider</span> <span class=p>=</span> <span class=k>new</span> <span class=n>BinaryClientFormatterSinkProvider</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>IClientChannelSinkProvider</span> <span class=n>clientChannelSinkProvider2</span> <span class=p>=</span> <span class=n>clientChannelSinkProvider</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clientChannelSinkProvider2</span><span class=p>.</span><span class=n>Next</span> <span class=p>=</span> <span class=k>new</span> <span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>GrpcClientTransportSinkProvider</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>prop</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>clientChannelSinkProvider</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//GrpcClientTransportSinkProvider</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>IClientChannelSink</span> <span class=n>CreateSink</span><span class=p>(</span><span class=n>IChannelSender</span> <span class=n>channel</span><span class=p>,</span> <span class=kt>string</span> <span class=n>url</span><span class=p>,</span> <span class=kt>object</span> <span class=n>remoteChannelData</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>GrpcClientTransportSink</span> <span class=n>grpcClientTransportSink</span> <span class=p>=</span> <span class=k>new</span> <span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>GrpcClientTransportSink</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=p>(</span><span class=n>GrpcClientChannel</span><span class=p>)</span><span class=n>channel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>prop</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>foreach</span> <span class=p>(</span><span class=kt>object</span> <span class=n>key</span> <span class=k>in</span> <span class=k>this</span><span class=p>.</span><span class=n>prop</span><span class=p>.</span><span class=n>Keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>grpcClientTransportSink</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>prop</span><span class=p>[</span><span class=n>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>grpcClientTransportSink</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//GrpcClientTransportSink#ProcessMessage</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>ProcessMessage</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>Remoting</span><span class=p>.</span><span class=n>Messaging</span><span class=p>.</span><span class=n>IMessage</span> <span class=n>msg</span><span class=p>,</span> <span class=n>ITransportHeaders</span> <span class=n>requestHeaders</span><span class=p>,</span> <span class=n>Stream</span> <span class=n>requestStream</span><span class=p>,</span> <span class=k>out</span> <span class=n>ITransportHeaders</span> <span class=n>responseHeaders</span><span class=p>,</span> <span class=k>out</span> <span class=n>Stream</span> <span class=n>responseStream</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//调用sendRequestWithRetry</span>
</span></span><span class=line><span class=cl>	<span class=n>Debugger</span><span class=p>.</span><span class=n>NotifyOfCrossThreadDependency</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>RemotingResponse</span> <span class=n>remotingResponse</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>sendRequestWithRetry</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=n>requestHeaders</span><span class=p>,</span> <span class=n>requestStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>responseHeaders</span> <span class=p>=</span> <span class=n>remotingResponse</span><span class=p>.</span><span class=n>Headers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>responseStream</span> <span class=p>=</span> <span class=n>remotingResponse</span><span class=p>.</span><span class=n>Content</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// sendRequestWithRetry</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>RemotingResponse</span> <span class=n>sendRequestWithRetry</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>Remoting</span><span class=p>.</span><span class=n>Messaging</span><span class=p>.</span><span class=n>IMessage</span> <span class=n>msg</span><span class=p>,</span> <span class=n>ITransportHeaders</span> <span class=n>requestHeaders</span><span class=p>,</span> <span class=n>Stream</span> <span class=n>requestStream</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>IMethodCallMessage</span> <span class=n>methodCallMessage</span> <span class=p>=</span> <span class=n>msg</span> <span class=k>as</span> <span class=n>IMethodCallMessage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>try</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>......</span>
</span></span><span class=line><span class=cl>		<span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>RemotingMessageRequest</span><span class=p>&gt;</span> <span class=n>enumerable</span> <span class=p>=</span> <span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>GrpcClientTransportSink</span><span class=p>.</span><span class=n>TransformToMessages</span><span class=p>&lt;</span><span class=n>RemotingMessageRequest</span><span class=p>&gt;(</span><span class=n>requestHeaders</span><span class=p>,</span> <span class=n>requestStream</span><span class=p>,</span> <span class=p>(</span><span class=n>methodCallMessage</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>?</span> <span class=n>methodCallMessage</span><span class=p>.</span><span class=n>Uri</span> <span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Grpc Channel AsyncDuplexStreamingCall调用</span>
</span></span><span class=line><span class=cl>		<span class=n>Uri</span> <span class=n>uri</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Uri</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Channel</span> <span class=n>clientChannel</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>channel</span><span class=p>.</span><span class=n>grpcChannelManager</span><span class=p>.</span><span class=n>GetClientChannel</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=n>Host</span><span class=p>,</span> <span class=n>uri</span><span class=p>.</span><span class=n>IsDefaultPort</span> <span class=p>?</span> <span class=m>55555</span> <span class=p>:</span> <span class=n>uri</span><span class=p>.</span><span class=n>Port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Remoting</span><span class=p>.</span><span class=n>RemotingClient</span> <span class=n>remotingClient</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Remoting</span><span class=p>.</span><span class=n>RemotingClient</span><span class=p>(</span><span class=n>clientChannel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>AsyncDuplexStreamingCall</span><span class=p>&lt;</span><span class=n>RemotingMessageRequest</span><span class=p>,</span> <span class=n>RemotingMessageReply</span><span class=p>&gt;</span> <span class=n>asyncDuplexStreamingCall</span> <span class=p>=</span> <span class=n>remotingClient</span><span class=p>.</span><span class=n>Send</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=k>default</span><span class=p>(</span><span class=n>CancellationToken</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=k>foreach</span> <span class=p>(</span><span class=n>RemotingMessageRequest</span> <span class=n>message</span> <span class=k>in</span> <span class=n>enumerable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>asyncDuplexStreamingCall</span><span class=p>.</span><span class=n>RequestStream</span><span class=p>.</span><span class=n>WriteAsync</span><span class=p>(</span><span class=n>message</span><span class=p>).</span><span class=n>Wait</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>asyncDuplexStreamingCall</span><span class=p>.</span><span class=n>RequestStream</span><span class=p>.</span><span class=n>CompleteAsync</span><span class=p>().</span><span class=n>Wait</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(!</span><span class=n>asyncDuplexStreamingCall</span><span class=p>.</span><span class=n>ResponseStream</span><span class=p>.</span><span class=n>MoveNext</span><span class=p>&lt;</span><span class=n>RemotingMessageReply</span><span class=p>&gt;().</span><span class=n>Result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>EndOfStreamException</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>RemotingMessageReply</span> <span class=n>remotingMessageReply</span> <span class=p>=</span> <span class=n>asyncDuplexStreamingCall</span><span class=p>.</span><span class=n>ResponseStream</span><span class=p>.</span><span class=n>Current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>RemotingResponse</span> <span class=n>remotingResponse</span> <span class=p>=</span> <span class=k>new</span> <span class=n>GrpcClientChannel</span><span class=p>.</span><span class=n>RemotingResponse</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Headers</span> <span class=p>=</span> <span class=n>remotingMessageReply</span><span class=p>.</span><span class=n>Headers</span><span class=p>.</span><span class=n>ToTransportHeaders</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=n>Content</span> <span class=p>=</span> <span class=k>new</span> <span class=n>MemoryStream</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=n>remotingMessageReply</span><span class=p>.</span><span class=n>Content</span><span class=p>.</span><span class=n>WriteTo</span><span class=p>(</span><span class=n>remotingResponse</span><span class=p>.</span><span class=n>Content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=kt>bool</span><span class=p>.</span><span class=n>Parse</span><span class=p>(</span><span class=n>remotingMessageReply</span><span class=p>.</span><span class=n>Headers</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span><span class=s>&#34;Chunked-Content&#34;</span><span class=p>,</span> <span class=kt>bool</span><span class=p>.</span><span class=n>FalseString</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>while</span> <span class=p>(</span><span class=n>asyncDuplexStreamingCall</span><span class=p>.</span><span class=n>ResponseStream</span><span class=p>.</span><span class=n>MoveNext</span><span class=p>&lt;</span><span class=n>RemotingMessageReply</span><span class=p>&gt;().</span><span class=n>Result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>remotingMessageReply</span> <span class=p>=</span> <span class=n>asyncDuplexStreamingCall</span><span class=p>.</span><span class=n>ResponseStream</span><span class=p>.</span><span class=n>Current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>remotingMessageReply</span><span class=p>.</span><span class=n>Content</span><span class=p>.</span><span class=n>WriteTo</span><span class=p>(</span><span class=n>remotingResponse</span><span class=p>.</span><span class=n>Content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>remotingResponse</span><span class=p>.</span><span class=n>Content</span><span class=p>.</span><span class=n>Seek</span><span class=p>(</span><span class=m>0L</span><span class=p>,</span> <span class=n>SeekOrigin</span><span class=p>.</span><span class=n>Begin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>remotingResponse</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></div><p>大致是<code>GrpcClientTransportSink#ProcessMessage-->sendRequestWithRetry-->remotingClient.Send</code>，说明和上面分析的出入不大。
理清楚这些之后，看看正常功能，使用ARM客户端登录就会得到如下调用栈</p><p><img class=tw-inline loading=lazy src=/133403918236818_8015063447851195489.png srcset="/133403918236818_8015063447851195489_hu6969473771737474795.webp 800w, /133403918236818_8015063447851195489_hu7989977487300332025.webp 1200w, /133403918236818_8015063447851195489_hu6150562424725646833.webp 1600w" height=424 width=1455></p><h2 id=漏洞分析 class=headerLink><a href=#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90 class=header-mark></a>漏洞分析</h2><p>之前提到过当.net Remoting当中设置了黑白名单时，可以关注MBR类的方法是否存在一些直接可调用的危险方法。剩下的就是遍历恶意的方法如文件读写、命令执行等，然后构造Channel客户端并找到对应的<code>objecturi</code>就能调用对应的的方法，整理了一些</p><div class=table-wrapper><table><thead><tr><th style=text-align:>URI</th><th style=text-align:>Service</th><th style=text-align:>namespace</th></tr></thead><tbody><tr><td style=text-align:>wusel</td><td style=text-align:>WuselImplementation</td><td style=text-align:>pn.server</td></tr><tr><td style=text-align:>gaffer</td><td style=text-align:>GafferImplementation</td><td style=text-align:>pn.gaffer</td></tr><tr><td style=text-align:>tattle</td><td style=text-align:>TattleImplementation</td><td style=text-align:>pn.server</td></tr><tr><td style=text-align:>update</td><td style=text-align:>UpdateSourceImplementation</td><td style=text-align:>pn.update</td></tr><tr><td style=text-align:>tracerServer</td><td style=text-align:>TracerServerImplementation</td><td style=text-align:>pn.tracer</td></tr><tr><td style=text-align:>farmServer</td><td style=text-align:>FarmServerImplementation</td><td style=text-align:>pn.server.farm</td></tr><tr><td style=text-align:>tracerCenter</td><td style=text-align:>TracerCenterImplementation</td><td style=text-align:>pn.tracer</td></tr><tr><td style=text-align:>jobCenter</td><td style=text-align:>JobCenterImplementation</td><td style=text-align:>pn.jobs</td></tr><tr><td style=text-align:>GenericGafferCredentialService</td><td style=text-align:>GenericGafferCredentialServiceImplementation</td><td style=text-align:>pn.connectors.generic.gaffer</td></tr><tr><td style=text-align:>logService</td><td style=text-align:>LogServiceImplementation</td><td style=text-align:>pn.server</td></tr><tr><td style=text-align:>ServerDebugger</td><td style=text-align:>ServerDebuggerImplementation</td><td style=text-align:>ServerDebuggerImplementation</td></tr></tbody></table></div><p>以上面的CVE为例，是TattleImplementation服务出现了任意文件读取的问题，只需要构造GrpcClientChannel注册grpc://IP:5555/tattle之后调用其方法，至于升级成RCE就需要利用.erlang.cookie( C:\ProgramData\SolarWinds\Orion\RabbitMQ\.erlang.cookie )的姿势了，这里不再详细说明。</p><h2 id=总结 class=headerLink><a href=#%e6%80%bb%e7%bb%93 class=header-mark></a>总结</h2><p>服务端为了实现更强大的功能可能就会碰到自定义的ServerChanel，还有基于UDP、Websocket等协议的，代码审计的关注点。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-12-26</span></div><div class=post-info-license></div></div><div class="post-info-line print:!tw-hidden"><div class=post-info-md></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><svg class="icon" viewBox="0 0 640 512"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg>&nbsp;<a href=/tags/.net/>.NET</a>,&nbsp;<a href=/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/>漏洞挖掘</a>,&nbsp;<a href=/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/>反序列化</a></section><section class=print:!tw-hidden><span><button class="tw-text-fgColor-link-muted hover:tw-text-fgColor-link-muted-hover" onclick=window.history.back()>返回</button></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class="post-nav print:tw-hidden"><a href=/posts/net/netremoting101/ class=prev rel=prev title="【.Net Remoting 系列一】101"><svg class="icon" viewBox="0 0 256 512"><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9.0l22.6 22.6c9.4 9.4 9.4 24.6.0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6.0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9.0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>【.Net Remoting 系列一】101</a>
<a href=/posts/net/netremoting-veeambackuprce/ class=next rel=next title=" 【.Net Remoting 系列三】 Veeam Backup .Net Remoting RCE (CVE-2024-40711)">【.Net Remoting 系列三】 Veeam Backup .Net Remoting RCE (CVE-2024-40711)<svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.140.2">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg> DoIt</a></div><div class=footer-line><svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532.0-2e2-89.451-2e2-2e2.0-110.531 89.451-2e2 2e2-2e2 110.532.0 2e2 89.451 2e2 2e2.0 110.532-89.451 2e2-2e2 2e2zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43.0-140.484-61.425-140.484-141.567.0-79.152 60.275-139.401 139.762-139.401 55.531.0 88.738 26.62 97.593 34.779a11.965 11.965.0 011.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303.0-77.916 35.33-77.916 80.082.0 41.589 26.888 83.692 78.277 83.692 32.657.0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947.0 01-1.152 15.518z"/></svg>2025<span class=author>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">g7shot</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons class=print:!tw-hidden><a href=#back-to-top id=back-to-top-button class="fixed-button tw-transition-opacity tw-opacity-0" title=回到顶部><svg class="icon" viewBox="0 0 448 512"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><script>window.config={"autocomplete.min.js":"/lib/autocomplete/autocomplete.min.js",comment:{},"fuse.min.js":"/lib/fuse/fuse.min.js",search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!1}}</script><script src=/js/theme.min.js defer></script><script type=speculationrules>
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script></body></html>